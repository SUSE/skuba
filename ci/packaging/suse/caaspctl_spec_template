#
# spec file for package caaspctl
#
# Copyright (c) 2019 SUSE LINUX GmbH, Nuernberg, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.

# Please submit bugfixes or comments via https://bugs.opensuse.org/
#


%define go_project github.com/SUSE/caaspctl
Name:           caaspctl
Version:        %%VERSION
Release:        0
Summary:        CLI tool used to deploy CaaS Platform v4
License:        Apache-2.0
Group:          System/Management
URL:            https://github.com/SUSE/caaspctl
Source0:        %{name}.tar.gz
BuildRequires:  go-go-md2man
BuildRequires:  golang-packaging
BuildRequires:  golang(API) >= 1.11
%{go_nostrip}
%{go_provides}

%description
caaspctl is a CLI tool that is used to initialize a CaaSP cluster and
bootstrap/add/remove nodes.

%package -n kubectl-caasp
Summary:        A caaspctl plugin for kubectl
Group:          System/Management
Requires:       caaspctl
Supplements:    caaspctl

%description -n kubectl-caasp
kubectl plugin that has the same layout as caaspctl. You can call to
the same commands presented in caaspctl as kubectl caasp when installing
the kubectl-caasp binary in your path.

%prep
%setup -q -n %{name}

%build
mkdir -pv $HOME/go/src/%{go_project}
cp -avr * $HOME/go/src/%{go_project}
cd $HOME/go/src/%{go_project}
%if %{caasp_build_environment} == "devel"
echo "Build with devel repos registry.suse.de/devel/caasp/4.0/containers/containers/caasp/v4"
make %{?_smp_mflags}
%else
echo "Build with %{caasp_build_environment} repos"
make %{?_smp_mflags} %{caasp_build_environment}
%endif
make %{?_smp_mflags} docs

%install

# Copy openstack terraform templates
install -d -m 0755 %{buildroot}/%{_datadir}/caasp/terraform/openstack
install -d -m 0755 ci/infra/openstack/cloud-init %{buildroot}/%{_datadir}/caasp/terraform/openstack/cloud-init
for file in ci/infra/openstack/*.*; do
  install -p -m 0644 $file %{buildroot}/%{_datadir}/caasp/terraform/openstack/
done
for file in ci/infra/openstack/cloud-init/*.*; do
  install -p -m 0644 $file %{buildroot}/%{_datadir}/caasp/terraform/openstack/cloud-init
done

# Copy vmware terraform templates
install -d -m 0755 %{buildroot}/%{_datadir}/caasp/terraform/vmware
install -d -m 0755 ci/infra/vmware/cloud-init %{buildroot}/%{_datadir}/caasp/terraform/vmware/cloud-init
for file in ci/infra/vmware/*.*; do
    # Load balancer is not supported by us, so the code will be stripped.
    if [[ $file =~ lb-instance.tf$ ]]; then
        continue
    fi
    install -p -m 0644 $file %{buildroot}/%{_datadir}/caasp/terraform/vmware/
done
for file in ci/infra/vmware/cloud-init/*.*; do
    # Load balancer is not supported by us, so the code will be stripped.
    if [[ $file =~ lb.tpl$ ]]; then
        continue
    fi
    install -p -m 0644 $file %{buildroot}/%{_datadir}/caasp/terraform/vmware/cloud-init
done

cd $HOME/go/bin
install -D -m 0755 caaspctl %{buildroot}/%{_bindir}/caaspctl
install -D -m 0755 kubectl-caasp %{buildroot}/%{_bindir}/kubectl-caasp

# Install docs
for file in $HOME/go/src/%{go_project}/docs/man/*.1; do
 install -D -m 0644 $file "%{buildroot}/%{_mandir}/man1/$(basename $file)"
done

%files -n kubectl-caasp
%{_bindir}/kubectl-caasp

%files
# Binaries
%{_bindir}/caaspctl
# Manpages
%doc README.md docs/*
%{_mandir}/man1/caaspctl*
# License
%license LICENSE.md
# Terraform files
%dir %{_datadir}/caasp/
%dir %{_datadir}/caasp/terraform/
%{_datadir}/caasp/terraform/openstack
%{_datadir}/caasp/terraform/openstack/cloud-init
%{_datadir}/caasp/terraform/vmware
%{_datadir}/caasp/terraform/vmware/cloud-init

%changelog
